<!DOCTYPE HTML>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

<script>
var Artsy = {}

Artsy.UrlGen = function(){
	var key = "dtleuaslkd6qxspmwfwzmgmq";
	var url = "https://openapi.etsy.com/v2/{controller}/{method}.js?api_key="+key;

	return {
		makeURL: function(controller,method){
			return url.replace("{controller}",controller).replace("{method}",method);
		}
	}
}

Artsy.Util = {}

Artsy.Util.tokenize = function (querystring) {
	// remove any preceding url and split
	querystring = querystring.substring(querystring.indexOf('#')+1).split('&');
	var params = {}, pair, d = decodeURIComponent;
	// march and parse
	for (var i = querystring.length - 1; i >= 0; i--) {
		pair = querystring[i].split('=');
		params[d(pair[0])] = d(pair[1]);
	}

	return params;
}

Artsy.Util.makepath = function (params) {
	var res = "#";
	for(e in params)
		res += e + "=" + encodeURIComponent(params[e]) + "&";
	return res;
}

Artsy.Listing = function(){
	var urlGen = new Artsy.UrlGen();

	var getCache = function(key,successcallback,fallback){
		if(typeof(Storage)!=="undefined"){
			if (sessionStorage[key] != null)
				successcallback(JSON.parse(sessionStorage[key]));
			else
				fallback(function(result){
					sessionStorage[key] = JSON.stringify(result);
				});
		}
		else
			fallback(function(){});
	}

	var search = function(callback,	params){
		var key = Artsy.Util.makepath(params);
		getCache(key,
			function(data){
				callback(data);
			},
			function(cachecallback){
		        $.ajax({
		            url: urlGen.makeURL("listings","active"),
		            data: params,
		            dataType: 'jsonp',
		            success: function(data) {
		                if (data.ok) {
		                	cachecallback(data);
		                	callback(data);
		                } else {
		                    return null;
		                }
		            }
		        });
    		}
		);
	}

	return {
		search: search,
		sorters: ["created", "price", "score" ]
	}
}

Artsy.SearchFormView = function(params){
	var controller = params.Controller;
	var template = "<div class='searchform'><input class='textfield' value='{Criteria}' /><input type='button' class='searchbutton' value='Search' /></div>";
	var events = {
		".searchbutton" : ["click",controller.search]
	}
	var id;


	return {
		render : function(criteria,htmlid){
			if (htmlid != null) id = htmlid;
			$("#"+id).html(template.replace("{Criteria}",criteria));

			for(e in events)
				$("#"+id + " " + e).on(events[e][0],events[e][1]);
		},
		getSearchCriteria: function(){
			return $("#"+id+" .textfield").val();
		}
	}
}

Artsy.SearchResultsView = function(params){
	var controller = params.Controller;
	var containertemplate = "<div class='searchresults'> \
		<div class='sorter'>Order by <select>{Sorters}</select></div> \
		<div class='itemlist'>{Content}</div> \
	</div>";
	var itemtemplate = " \
		<div class='item' data-id='{listing_id}'>{title}<br />{price} {currency_code}</div> \
	";
	
	var events = {
		".sorter" : ["change",  controller.search],
		".item"   : ["click",   controller.details]
	};
	var id;

	var renderSorters = function(){
		var s = new Artsy.Listing();
		var res = "";
		for(sorter in s.sorters)
			res += "<option>"+s.sorters[sorter]+"</option>"
		return res;
	}

	var renderResults = function(data){
		var res = "";
		if (data != null)
			for(listing in data.results){
				var itemres = itemtemplate;
				var item = data.results[listing];
				for(field in item)
					itemres = itemres.replace("{"+field+"}",item[field]);
				res += itemres;
			}
		return res;
	}

	var render = function(data,htmlid){
		if (htmlid != null) id = htmlid;
		var results = renderResults(data);
		var sorters = renderSorters();
		var resulthtml = containertemplate.replace("{Content}",results).replace("{Sorters}",sorters);

		$("#"+id).html(resulthtml);
		for(e in events)
			$("#"+id + " " + e).on(events[e][0],events[e][1]);
	}

	return {
		render : render,
		setData: function(data){
			data = data;
			this.render();
		},
		getSortOrder: function(){
			return $("#"+id+" .sorter select").val();
		}
	}
}

Artsy.SearchDetailsView = function(params){
	var controller = params.Controller;
	var template = "<div class='listingdetail' data-id='{listing_id}''> \
		<div class='listingshopsection'>{shop_section_id}</div> \
		<div class='listingcategory'>{category_path} {category_path_ids}</div> \
		<div class='listingtitle'><a href='{url}' target='_blank'>{title}</a></div> \
		<div class='listingdescription'>{description}</div> \
		<div class='listingtags'>{tags}</div> \
		<div class='listingsocial'>Views: {views} Likes: {num_favorers}</div> \
		<div class='listingdetailline'><span class='heading'>Status :</span>          <span class='value'>{state}</span></div> \
		<div class='listingdetailline'><span class='heading'>User :</span>            <span class='value'>{user_id}</span></div> \
		<div class='listingdetailline'><span class='heading'>Category :</span>        <span class='value'>{category_id}</span></div> \
		<div class='listingdetailline'><span class='heading'>Created :</span>         <span class='value'>{creation_tsz}</span></div> \
		<div class='listingdetailline'><span class='heading'>Ends :</span>            <span class='value'>{ending_tsz}</span></div> \
		<div class='listingdetailline'><span class='heading'>Price :</span>           <span class='value'>{price} {currency_code}</span></div> \
		<div class='listingdetailline'><span class='heading'>Quantity :</span>        <span class='value'>{quantity}</span></div> \
		<div class='listingdetailline'><span class='heading'>Materials :</span>       <span class='value'>{materials}</span></div> \
		<div class='listingdetailline'><span class='heading'>Shipping :</span>        <span class='value'>{shipping_template_id}</span></div> \
		<div class='listingdetailline'><span class='heading'>Processing time :</span> <span class='value'>{processing_min} - {processing_max}</span></div> \
		<div class='listingdetailline'><span class='heading'>Made by :</span>         <span class='value'>{who_made}</span></div> \
		<div class='listingdetailline'><span class='heading'>Supply :</span>          <span class='value'>{is_supply}</span></div> \
		<div class='listingdetailline'><span class='heading'>Made in :</span>         <span class='value'>{when_made}</span></div> \
		<div class='listingdetailline'><span class='heading'>Made for :</span>        <span class='value'>{recipient}</span></div> \
		<div class='listingdetailline'><span class='heading'>Occasion :</span>        <span class='value'>{occasion}</span></div> \
		<div class='listingdetailline'><span class='heading'>Style :</span>           <span class='value'>{style}</span></div> \
		<div class='listingdetailline'><span class='heading'>Non-taxable :</span>     <span class='value'>{non_taxable}</span></div> \
		<div class='listingdetailline'><span class='heading'>Customizable :</span>    <span class='value'>{is_customizable}</span></div> \
		<div class='listingdetailline'><span class='heading'>Digital media:</span>    <span class='value'>{is_digital}</span></div> \
		<div class='listingdetailline'><span class='heading'>Variations :</span>      <span class='value'>{has_variations}</span></div> \
	</div>";
	var events = {
		".searchbutton" : ["click",controller.search]
	}
	var id;


	return {
		render : function(data,htmlid){
			if (htmlid != null) id = htmlid;
			var res = template;
			if (data != null)
				for(field in data)
					res = res.replace("{"+field+"}",data[field]);
			else
				res = "";

			$("#"+id).html(res);

			for(e in events)
				$("#"+id + " " + e).on(events[e][0],events[e][1]);
		}
	}
}

Artsy.SearchController = function(){
	var searcher, searchform, searchresultsview, searchdetailsview;
	var searchcriteria = {};
	var searchresults;

	var search = function(){
		var params = {};
		params.sort_on = searchresultsview.getSortOrder();
		params.keywords = searchform.getSearchCriteria();
		location.hash = Artsy.Util.makepath(params);
	}

	var details = function(){
		listingid = $(this).attr("data-id");
		for (item in searchresults.results)
			if (searchresults.results[item].listing_id == listingid){
				searchdetailsview.render(searchresults.results[item]);
			}
	}

	var navigate = function(){
		searchcriteria = Artsy.Util.tokenize(location.hash);
		searchform.render(searchcriteria.keywords,"searchform");

		if (location.hash != "")
			searcher.search(function(data){
				searchresults = data;
				searchresultsview.render(searchresults);
			},searchcriteria);
	}

	return {
		search : search,
		searcher: searcher,
		searchform: searchform,
		searchresults: searchresultsview,
		searchdetailsview: searchdetailsview,
		details: details,
		init : function(){
			searcher = new Artsy.Listing();

			searchform = new Artsy.SearchFormView({Controller: this});
			searchresultsview = new Artsy.SearchResultsView({Controller: this});
			searchdetailsview = new Artsy.SearchDetailsView({Controller: this});

			searchform.render("","searchform");
			searchdetailsview.render(null,"searchresults");
			searchresultsview.render(null,"listingdetail");

			window.onhashchange = navigate;
			if (location.hash != "") navigate();
		}
	}
}

var App = {}
App.Search = new Artsy.SearchController();

$(document).ready(function(){
	App.Search.init();
});


</script>
<style>
.artsy .searchresults{
	float:left;
	width: 50%;
}
.artsy .listingdetail{
	float:right;
	width: 50%;
}
</style>
</head>
<body>
<div class="artsy">
	<div id="searchform"></div>
	<div id="searchresults"></div>
	<div id="listingdetail"></div>
</div>
</body>	